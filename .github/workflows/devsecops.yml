name: DevSecOps

on:
  push:
    branches: ["main", "master"]
  pull_request:

permissions:
  contents: read
  security-events: write

jobs:
  dependency-check:
    name: OWASP Dependency-Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - discovery-service
          - gateway-service
          - order-service
          - product-service
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven
      - name: Dependency Check
        run: |
          mvn -f ${{ matrix.service }}/pom.xml -B org.owasp:dependency-check-maven:check \
            -Dformat=HTML -DfailBuildOnCVSS=7
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-${{ matrix.service }}
          path: ${{ matrix.service }}/target/dependency-check-report.html

  trivy:
    name: Trivy image scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - discovery-service
          - gateway-service
          - order-service
          - product-service
          - frontend-angular
    steps:
      - uses: actions/checkout@v4
      - name: Build image
        run: docker build -t ${{ matrix.service }}:scan ${{ matrix.service }}
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:scan
          format: sarif
          output: trivy-${{ matrix.service }}.sarif
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-${{ matrix.service }}.sarif

  sonar:
    if: ${{ secrets.SONAR_TOKEN != '' }}
    name: SonarQube (optional)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - discovery-service
          - gateway-service
          - order-service
          - product-service
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven
      - name: Cache Sonar packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
      - name: Sonar scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
        run: |
          mvn -B -f ${{ matrix.service }}/pom.xml -DskipTests sonar:sonar \
            -Dsonar.host.url=${SONAR_HOST_URL:-https://sonarcloud.io} \
            -Dsonar.login=$SONAR_TOKEN \
            $( [ -n "$SONAR_ORGANIZATION" ] && echo "-Dsonar.organization=$SONAR_ORGANIZATION" ) \
            -Dsonar.projectKey=${{ github.repository }}-${{ matrix.service }} \
            -Dsonar.projectName=${{ matrix.service }}
